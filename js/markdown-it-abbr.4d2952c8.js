var m=function(f){var s=f.utils.escapeRE,E=f.utils.arrayReplaceAt,x=" \r\n$+<=>^`|~",k=f.utils.lib.ucmicro.P.source,d=f.utils.lib.ucmicro.Z.source;function C(e,c,b,p){var a,n,l,o,t,r=e.bMarks[c]+e.tShift[c],i=e.eMarks[c];if(r+2>=i||e.src.charCodeAt(r++)!==42||e.src.charCodeAt(r++)!==91)return!1;for(o=r;r<i;r++){if(l=e.src.charCodeAt(r),l===91)return!1;if(l===93){t=r;break}else l===92&&r++}return t<0||e.src.charCodeAt(t+1)!==58?!1:p?!0:(a=e.src.slice(o,t).replace(/\\(.)/g,"$1"),n=e.src.slice(t+2,i).trim(),a.length===0||n.length===0?!1:(e.env.abbreviations||(e.env.abbreviations={}),typeof e.env.abbreviations[":"+a]=="undefined"&&(e.env.abbreviations[":"+a]=n),e.line=c+1,!0))}function R(e){var c,b,p,a,n,l,o,t,r,i,_,A,v,h=e.tokens;if(!!e.env.abbreviations){for(A=new RegExp("(?:"+Object.keys(e.env.abbreviations).map(function(u){return u.substr(1)}).sort(function(u,g){return g.length-u.length}).map(s).join("|")+")"),_="(^|"+k+"|"+d+"|["+x.split("").map(s).join("")+"])("+Object.keys(e.env.abbreviations).map(function(u){return u.substr(1)}).sort(function(u,g){return g.length-u.length}).map(s).join("|")+")($|"+k+"|"+d+"|["+x.split("").map(s).join("")+"])",r=new RegExp(_,"g"),b=0,p=h.length;b<p;b++)if(h[b].type==="inline"){for(a=h[b].children,c=a.length-1;c>=0;c--)if(v=a[c],v.type==="text"&&(t=0,l=v.content,r.lastIndex=0,o=[],!!A.test(l))){for(;i=r.exec(l);)(i.index>0||i[1].length>0)&&(n=new e.Token("text","",0),n.content=l.slice(t,i.index+i[1].length),o.push(n)),n=new e.Token("abbr_open","abbr",1),n.attrs=[["title",e.env.abbreviations[":"+i[2]]]],o.push(n),n=new e.Token("text","",0),n.content=i[2],o.push(n),n=new e.Token("abbr_close","abbr",-1),o.push(n),r.lastIndex-=i[3].length,t=r.lastIndex;!o.length||(t<l.length&&(n=new e.Token("text","",0),n.content=l.slice(t),o.push(n)),h[b].children=a=E(a,c,o))}}}}f.block.ruler.before("reference","abbr_def",C,{alt:["paragraph","reference"]}),f.core.ruler.after("linkify","abbr_replace",R)};export{m};
